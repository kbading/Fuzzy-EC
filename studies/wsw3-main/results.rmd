---
title : "Experiment 3"
author: "Karoline Bading & Marius Barth"
date  : "`r Sys.Date()`"
abstract: |
  *Beware, this is a test script!*
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---



```{r setup, include = FALSE}
library(afex)
library(emmeans)
library(papaja)
library(memoise)
library(HMMTreeC)

project_root <- rprojroot::find_rstudio_root_file()
study_folder <- file.path(project_root, "studies", "wsw3-main")

set_sum_contrasts()

knitr::opts_chunk$set(
  echo = TRUE
  , message = FALSE
)

source(file.path(project_root, "R", "mptinr_helper.R"))

file_cache <- cache_filesystem(path = file.path(project_root, ".rcache"), compress = "gzip", algo = "md5")
simpleMPT <- memoise(TreeBUGS::simpleMPT, cache = file_cache)
BayesFactorMPT <- memoise(TreeBUGS::BayesFactorMPT, cache = file_cache)
```

```{r}
wesanderson::wes_palette("Zissou1", n = 3, type = "continuous") |>
  palette()
```


```{r exp3-read-data}
data <- readRDS(file.path(study_folder, "data", "data.rds"))
rating <- data$rating
mpt_data <- data$mpt_data
```


## Evaluative rating

```{r}
table(subset(rating, !duplicated(sid))$task_focus)
ftable(us_valence ~ sid + us_age, data = rating)
```

```{r exp3-ratings}
apa_beeplot(
  data = subset(rating, !is.na(us_valence))
  , id = "sid"
  , dv = "evaluative_rating"
  , factors = c("task_focus", "us_valence")
  , ylim = c(1, 8)
  , args_legend = list(x = "topleft")
)

anova_rating_model <- aov_4(
  formula = evaluative_rating ~ task_focus * (us_valence | sid)
  , data = subset(rating, !is.na(us_valence))
  , fun_aggregate = mean
)

marginal_means <- emmeans(
  anova_rating_model
  , specs = ~ us_valence + task_focus
) |>
  contrast(
    list(
      "EC effect, age-focus condition"       = c(1, -1, 0, 0)
      , "EC effect, valence-focus condition" = c(0, 0, 1, -1)
    )
    , side = ">"
  )

anova_rating <- apa_print(anova_rating_model)

rating_aggregated <- aggregate(evaluative_rating ~ us_valence + task_focus + sid, data = rating, FUN = mean)
rating_wide <- tidyr::pivot_wider(rating_aggregated, values_from = "evaluative_rating", names_from = "us_valence") |>
  within({
    ec_effect <- positive - negative
  })
apa_print(marginal_means) |>
  apa_table(caption = "EC effects for both task-focus conditions.")
```

Figure\ \@ref(fig:exp3-ratings) shows mean evaluative ratings.
We analyzed evaluative ratings using
a 2(*task focus*: valence vs. age) $\times$ 2 (*US valence*: positive vs. negative) mixed-factorial ANOVA
that revealed
a main effect *US valence*,
`r anova_rating$full_result$us_valence` that was qualified by
the two-way interaction *US valence* and *task focus*,
`r anova_rating$full_result$task_focus_us_valence`.
The main effect of *task focus* condition was not significant,
`r anova_rating$full_result$task_focus`.

```{r eval = FALSE}
lme_model <- lmer(
  formula = evaluative_rating ~ us_valence * task_focus + (us_valence | sid) + (1 | cs)
  , data = subset(rating, !is.na(us_valence)) 
)
summary(lme_model)
ggeffects::ggpredict(lme_model, terms = ~ task_focus + us_valence) |>
  plot()
```


## MPT model



```{r exp3-ml-models}
baseline_restrictions <- list(
  G_x1 = .125
  , G_x2 = .125
)

hypothesis_restrictions <- list(
  baseline = list()
  , D_equal = list(D = c("D_x1", "D_x2"))
  , C_equal = list(C = c("C_x1", "C_x2"))
  , d_equal = list(d = c("d_x1", "d_x2"))
  , a_equal = list(a = c("a_x1", "a_x2"))
  , b_equal = list(b = c("b_x1", "b_x2"))
  # , Dage0   = list("D_x1=0")
  # , Dval0   = list("D_x2=0")
  # , Cage0   = list("C_x1=0")
  # , Cval0   = list("C_x2=0")
  # , dage0   = list("d_x1=0")
  # , dval0   = list("d_x2=0")
  # , bage5   = list("b_x1=0.5")
  # , bval5   = list("b_x2=0.5")
  # , aage5   = list("a_x1=0.5")
  # , aval5   = list("a_x2=0.5")
)

models <- lapply(
  hypothesis_restrictions
  , FUN = function(x) {
    fit_mpt(
      data = mpt_data
      , model = file.path(study_folder, "WSW_exp3.eqn")
      , restrictions = c(baseline_restrictions, x)
    )
  }
)
plot(
  models$baseline
  , factors = list("Task focus" = c(age = "_x1", valence = "_x2"))
  , parameters = c(
    D = expression(italic(D))
    , C = expression(italic(C))
    , d = expression(italic(d))
    # , G = expression(italic(g))
    , a = expression(italic(a))
    , b = expression(italic(b))
  )
)
```

```{r}
models$baseline
```


```{r exp3-compare-ml-models}
compare(models)
```

## Bayesian MPT model

```{r exp3-simple-mpt}
baseline_restrictions <- list(
  "G_x1 = G_x2 = .125"
)

simple_mpt <- lapply(
  hypothesis_restrictions
  , FUN = function(x) {
    # return(lapply(c(baseline_restrictions, x), FUN = paste, collapse = " = "))
    simpleMPT(
      eqnfile = file.path(study_folder, "WSW_exp3.eqn")
      , data = colSums(mpt_data)
      , restrictions = lapply(c(baseline_restrictions, x), FUN = paste, collapse = " = ")
      , n.iter   = 2e4L # 2e5L
      , n.burnin = 1e4L # 1e5L
      , n.thin   = 2e1L
      , ppp      = 5e2L # 5e3L
      , n.chains = 4e0L
      , cores    = 4e0L
    )
  }
)
BFs <- BayesFactorMPT(simple_mpt, cores = 4L)

# Compare baseline model with other models
data.frame(
  model = paste0("Effect of task focus on ", gsub(names(BFs$posterior[-1L]), pattern = "_equal", replacement = ""))
  , logBF = log(BFs$posterior[-1L]) - log(BFs$posterior[[1L]])
  , row.names = NULL
) |> within({
  strong_evidence <- ifelse(abs(logBF) > log(10), "yes", "no")
  BF_01 <- exp( logBF)
  BF_10 <- exp(-logBF)
}) |>
  apa_table()

```
