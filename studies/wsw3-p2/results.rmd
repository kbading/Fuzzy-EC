---
title: "Test Script for who-said-what experiment 3"
author: "Karoline Bading & Marius Barth"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_float: yes
    code_folding: hide
  pdf_document:
    toc: yes
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyr)

library(afex)
library(emmeans)
library(papaja)

set_sum_contrasts()

knitr::opts_chunk$set(
  echo = TRUE
  , message = FALSE
  , comment = NA
)

source(file.path(rprojroot::find_rstudio_root_file(), "R", "mptinr_helper.R"))
```


```{r}
study_folder <- file.path(rprojroot::find_rstudio_root_file(), "studies", "wsw3-p2")
mpt_data <- readRDS(file.path(study_folder, "data", "mpt_data.rds"))
mpt_aggregated <- colSums(mpt_data)

rating <- readRDS(file.path(study_folder, "data", "rating.rds"))
```


## Evaluative rating

```{r}
apa_beeplot(
  data = subset(rating, !is.na(us_valence))
  , id = "sid"
  , dv = "evaluative_rating"
  , factors = c("task_focus", "us_valence")
  , ylim = c(1, 8)
  , args_legend = list(x = "topleft")
)

anova_rating_model <- aov_4(
  formula = evaluative_rating ~ task_focus * (us_valence | sid)
  , data = subset(rating, !is.na(us_valence))
  , fun_aggregate = mean
)

marginal_means <- emmeans(
  anova_rating_model
  , specs = ~ us_valence + task_focus
) |>
  contrast(
    list(
      "EC effect, age-focus condition"       = c(1, -1, 0, 0)
      , "EC effect, valence-focus condition" = c(0, 0, 1, -1)
    )
    , side = ">"
  )

anova_rating <- apa_print(anova_rating_model)

rating_aggregated <- aggregate(evaluative_rating ~ us_valence + task_focus + sid, data = rating, FUN = mean)
rating_wide <- pivot_wider(rating_aggregated, values_from = "evaluative_rating", names_from = "us_valence") |>
  within({
    ec_effect <- positive - negative
  })
marginal_means
```

main effect *task focus*,
`r anova_rating$full_result$task_focus`,
main effect *US valence*,
`r anova_rating$full_result$us_valence`,
two-way interaction *task focus* with *US valence*,
`r anova_rating$full_result$task_focus_us_valence`.

```{r eval = FALSE}
lme_model <- lmer(
  formula = evaluative_rating ~ us_valence * task_focus + (us_valence | sid) + (1 | cs)
  , data = subset(rating, !is.na(us_valence)) 
)
summary(lme_model)
ggeffects::ggpredict(lme_model, terms = ~ task_focus + us_valence) |>
  plot()
```



## MPT model

```{r}
restrictions_list <- list(
  x  = list("G_x1=.125","G_x2=.125")
  , Dageval = list("G_x1=.125","G_x2=.125", "D_x1=D_x2")
  , Cageval = list("G_x1=.125","G_x2=.125", "C_x1=C_x2")
  , dageval = list("G_x1=.125","G_x2=.125", "d_x1=d_x2")
  , aageval = list("G_x1=.125","G_x2=.125", "a_x1=a_x2")
  , bageval = list("G_x1=.125","G_x2=.125", "b_x1=b_x2")
  , Dage0   = list("G_x1=.125","G_x2=.125", "D_x1=0")
  , Dval0   = list("G_x1=.125","G_x2=.125", "D_x2=0")
  , Cage0   = list("G_x1=.125","G_x2=.125", "C_x1=0")
  , Cval0   = list("G_x1=.125","G_x2=.125", "C_x2=0")
  , dage0   = list("G_x1=.125","G_x2=.125", "d_x1=0")
  , dval0   = list("G_x1=.125","G_x2=.125", "d_x2=0")
  , bage5   = list("G_x1=.125","G_x2=.125", "b_x1=0.5")
  , bval5   = list("G_x1=.125","G_x2=.125", "b_x2=0.5")
  , aage5   = list("G_x1=.125","G_x2=.125", "a_x1=0.5")
  , aval5   = list("G_x1=.125","G_x2=.125", "a_x2=0.5")
)

models <- lapply(
  restrictions_list
  , FUN = function(x) {
    fit.mpt(
      data = mpt_aggregated
      , model.filename = file.path(study_folder, "WSW_exp3.eqn")
      , restrictions.filename = x
    )
  }
)
```

```{r}
model_comparisons <- do.call("anova", models)
model_comparisons |> printCoefmat(digits = 3, has.Pvalue = T, eps.Pvalue = .001)
```



## Hierarchical MPT model

```{r}
mpt_data_hierarchical <- readRDS(file.path(study_folder, "data", "mpt_data_hierarchical.rds")) |>
  merge(rating_wide, sort = FALSE) |>
  within({
    ec_valence_focus <- (task_focus == "valence") * ec_effect
    ec_age_focus <- (task_focus == "age") * ec_effect
  })
```


```{r}
trait_mpt <- function(file, ...) {
  if( file.exists(file) ) {
    model <- qs::qread(file)
  } else {
    model <- TreeBUGS::traitMPT(...)
    qs::qsave(model, file = file)
  }
  model
}

# Estimate parameters
exp3pilot = trait_mpt(
  file = file.path(study_folder, "model-objects", "trait_mpt.qs")
  , eqnfile = file.path(study_folder, "WSW_exp3_hierarchical.eqn")
  , data = mpt_data_hierarchical
  , n.adapt  = 2e3
  , n.burnin = 2e4
  , n.thin   = 2e1
  , n.iter   = 4e4
  , n.chains = 4
  , restrictions = list("G=0.125")
  , ppp = 5e3
  , covData = mpt_data_hierarchical[, "task_focus", drop = FALSE]
  , predStructure = list("a b D d C; task_focus")
  , IVprec = "dgamma(.5,.5)"
  , predType = rep("f", 1L)
)
```

```{r}
TreeBUGS::plotFit(exp3pilot)
TreeBUGS::plotFreq(exp3pilot)
TreeBUGS::plotParam(exp3pilot)
```

```{r}
summary(exp3pilot)
```


## Hierarchical MPT model w/ EC effects as predictors

```{r}
# Estimate parameters
mpt_model_ec_predictor <-  trait_mpt(
  file = file.path(study_folder, "model-objects", "trait_mpt_ec_as_predictor.qs")
  , eqnfile = file.path(study_folder, "WSW_exp3_hierarchical.eqn")
  , data = mpt_data_hierarchical
  , n.adapt  = 2e3
  , n.burnin = 2e4
  , n.thin   = 2e1
  , n.iter   = 4e4
  , n.chains = 4
  , restrictions = list("G=0.125")
  , ppp = 5e3
  , covData = mpt_data_hierarchical[, c("task_focus", "ec_age_focus", "ec_valence_focus"), drop = FALSE]
  , predStructure = list("a b D d C; task_focus", "a b D d C; ec_age_focus", "a b D d C; ec_valence_focus")
  , IVprec = "dgamma(.5,.5)"
  , predType = c("f", "c", "c")
)
```

```{r}
summary(mpt_model_ec_predictor)
```


```{r}
simple_mpt <- list(NULL, "d_x1 = d_x2") |>
  lapply(function(x) {
    TreeBUGS::simpleMPT(
      eqnfile = file.path(study_folder, "WSW_exp3.eqn")
      , data = colSums(mpt_data)
      , restrictions = list("G_x1=G_x2= 0.125", x)
      , n.iter   = 4e4
      , n.burnin = 2e4
      , n.thin   = 2e1
      , n.chains = 4
      , ppp      = 5e3
      , cores    = 4L
      # , alpha = c(a_x1 = 20, a_x2 = 20)
      # , beta  = c(a_x1 = 20, a_x2 = 20)
    )
})
BFs <- TreeBUGS::BayesFactorMPT(simple_mpt)
BFs$posterior[1] / BFs$posterior[2]
lapply(simple_mpt, summary)[[1L]]
```





```{r eval = TRUE}
library(TreeBUGS)
individual_parameters <- as.data.frame(getParam(mpt_model_ec_predictor, parameter = "theta"))
parameter_names <- colnames(individual_parameters)

tt <- transformedParameters(mpt_model_ec_predictor,
  list("p_us_identity = D*C", "p_us_valence = D*(1-C)*d"),
  level = "individual"
) |>
  do.call(what = "rbind") |>
  colMeans()

branch_probabilities <- data.frame(
  p_us_valence = tt[grepl(names(tt), pattern = "p_us_valence")]
  , p_us_identity = tt[grepl(names(tt), pattern = "p_us_identity")]
  , row.names = NULL
)

#individual_parameters$id <- rownames(individual_parameters)
para_ratings_both<- cbind(mpt_data_hierarchical, individual_parameters, branch_probabilities)
#save(para_ratings_both,file = "exp3pilot_x_ratings_val.rdata")
data <- para_ratings_both
#data$ec <- data$positive - data$negative
t.test(data$ec_effect)
#data$task_focus <- factor(data$task_focus, levels = c("age_task","val_task"))

library(lme4)
library(ggeffects)
```

## Mediation


```{r eval = FALSE}
library(mediation)
mediation_results <- mediate(
  model.m = lm(d ~ task_focus, data = data)
  , model.y = lm(ec_effect ~ d * task_focus, data = data)
  , mediator = "d"
  , treat = "task_focus"
  , treat.value = "valence"
  , control.value = "age"
)
summary(mediation_results)
```


### with parameter estimates as predictors

```{r }
library(lavaan)
z <- function(x) {as.numeric(scale(x))}

data <- within(data, {
  Dd <- z(D) * z(d)
  DC <- z(D) * z(C)
  dC <- z(d) * z(C)
  DdC <- z(D) * z(d) * z(C)
})


mediation_syntax <-"
    # Regressions
    D ~ a_D*task_focus 
    C ~ a_C*task_focus
    d ~ a_d*task_focus
    # b ~ a_b*task_focus
    # a ~ a_a*task_focus
    Dd ~ a_Dd*task_focus
    DC ~ a_DC*task_focus
    dC ~ a_dC*task_focus
    DdC ~ a_DdC*task_focus
    # ec_effect ~ b_D*D + b_C*C + b_d*d + b_b*b + b_a*a + b_Dd*Dd + b_DC*DC + b_dC*dC + b_DdC*DdC + ade*task_focus
    ec_effect ~ b_D*D + b_C*C + b_d*d + b_Dd*Dd + b_DC*DC + b_dC*dC + b_DdC*DdC + ade*task_focus
    
    #Define New Parameters
    ab_D := a_D*b_D                                   #the product term is computed as a*b
    ab_C := a_C*b_C
    ab_d := a_d*b_d
    ab_Dd := a_Dd*b_Dd
    ab_DC := a_DC*b_DC
    ab_dC := a_dC*b_dC
    ab_DdC := a_DdC*b_DdC
    total_effect := ade + ab_D + ab_C + ab_d + ab_Dd + ab_DC + ab_dC + ab_DdC  #having defined ab, we can use this here.
"

sem(mediation_syntax, data = data) |>
  summary(standardized=TRUE)
```

```{r}
ec_lm <- lm(formula = ec_effect ~ D * C * d, data = data)
ec_lm |>
  marginaleffects::plot_predictions(condition = c("d", "C"))

ec_lm |>
  marginaleffects::plot_predictions(condition = c("C", "d"))

emtrends(ec_lm, var = "d", specs = ~ C, at = list(C = c(0, .1, .2, .3, .8))) |>
  summary(infer = TRUE)

emtrends(ec_lm, var = "C", specs = ~ d, at = list(d = ppoints(n = 10))) |>
  summary(infer = TRUE)
```

```{r}
lm(formula = ec_effect ~ D * C * d + task_focus, data = data) |>
  ggeffect(terms = ~ d:D) |>
  plot(show_data = TRUE)
```


How could we explain this interaction pattern?

- $d$ is a proxy for participants' eagerness to encode valence, so participants with small $d$ but high $C$ maybe did not encode valence (for both C and not-C items).
- 



### with unconditional probabilities of US-valence and US-identity memory as predictors

```{r}
# hist(data$p_us_identity)
# hist(data$p_us_valence)
data$ln_us_identity <- qnorm(data$p_us_identity)
data$ln_us_valence <- qnorm(data$p_us_valence)
data$I_valence_memory <- data$ln_us_identity * data$ln_us_valence

mediation_syntax <-"
    # Regressions
    # D ~ a_D*task_focus 
    # C ~ a_C*task_focus
    # d ~ a_d*task_focus
    # b ~ a_b*task_focus
    # a ~ a_a*task_focus
    ln_us_valence  ~ a_us_valence*task_focus
    ln_us_identity ~ a_us_identity*task_focus
    I_valence_memory ~ a_inter*task_focus
    ec_effect ~ b_us_valence*ln_us_valence + b_us_identity*ln_us_identity + b_inter*I_valence_memory + ade*task_focus
    
    #Define New Parameters
    ab_us_valence := a_us_valence*b_us_valence
    ab_us_identity := a_us_identity*b_us_identity
    ab_inter := a_inter*b_inter
    c := ade + ab_us_valence + ab_us_identity + ab_inter #having defined ab, we can use this here.
"

path_model <- sem(mediation_syntax, data = data)
path_model |>
  summary(standardized=TRUE)

# m1 <- lm(ln_us_identity ~ task_focus, data = data) |>
#   plot()
# m2 <- lm(ln_us_valence ~ task_focus, data = data) |>
#   plot()
lm(ec_effect ~ task_focus + ln_us_identity * ln_us_valence, data = data) |>
  ggpredict(terms = ~ ln_us_valence + ln_us_identity) |>
  plot(show_data = TRUE)
```

